<div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-900">Settings</h2>
    <p class="text-sm text-gray-500">Configure business details and application preferences.</p>
</div>

<% if (typeof success !== 'undefined' && success) { %>
<div class="mb-6 bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg text-sm flex items-center gap-2">
    <i data-lucide="check-circle" class="w-5 h-5"></i>
    Settings saved successfully. Changes will sync to the Desktop App shortly.
</div>
<% } %>

<% if (typeof error !== 'undefined' && error) { %>
<div class="mb-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm flex items-center gap-2">
    <i data-lucide="alert-circle" class="w-5 h-5"></i>
    <%= error %>
</div>
<% } %>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6" x-data="{ activeTab: 'business' }">
    <!-- Settings Navigation -->
    <div class="lg:col-span-1">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden sticky top-6">
            <nav class="flex flex-col">
                <button @click="activeTab = 'business'"
                    :class="activeTab === 'business' ? 'bg-blue-50 text-blue-700 border-blue-600' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-transparent'"
                    class="flex items-center gap-3 px-4 py-3 border-l-4 text-sm font-medium transition-colors text-left">
                    <i data-lucide="store" class="w-5 h-5"></i>
                    Business Info
                </button>
                <button @click="activeTab = 'payment'"
                    :class="activeTab === 'payment' ? 'bg-blue-50 text-blue-700 border-blue-600' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-transparent'"
                    class="flex items-center gap-3 px-4 py-3 border-l-4 text-sm font-medium transition-colors text-left">
                    <i data-lucide="credit-card" class="w-5 h-5"></i>
                    Payment Methods
                </button>
                <button @click="activeTab = 'tax'"
                    :class="activeTab === 'tax' ? 'bg-blue-50 text-blue-700 border-blue-600' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-transparent'"
                    class="flex items-center gap-3 px-4 py-3 border-l-4 text-sm font-medium transition-colors text-left">
                    <i data-lucide="percent" class="w-5 h-5"></i>
                    Tax Settings
                </button>
                <button @click="activeTab = 'receipt'"
                    :class="activeTab === 'receipt' ? 'bg-blue-50 text-blue-700 border-blue-600' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-transparent'"
                    class="flex items-center gap-3 px-4 py-3 border-l-4 text-sm font-medium transition-colors text-left">
                    <i data-lucide="printer" class="w-5 h-5"></i>
                    Receipt Settings
                </button>
                 <button @click="activeTab = 'devices'"
                    :class="activeTab === 'devices' ? 'bg-blue-50 text-blue-700 border-blue-600' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900 border-transparent'"
                    class="flex items-center gap-3 px-4 py-3 border-l-4 text-sm font-medium transition-colors text-left">
                    <i data-lucide="smartphone" class="w-5 h-5"></i>
                    Connected Devices
                </button>
            </nav>
        </div>
    </div>

    <!-- Settings Form -->
    <div class="lg:col-span-2">
        <form action="/settings" method="POST">

            <!-- Business Info Tab -->
            <div x-show="activeTab === 'business'" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-6">Business Information</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Business Name</label>
                            <input type="text" name="businessName" value="<%= settings.businessName %>" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                            <input type="tel" name="phone" value="<%= settings.phone %>" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                        <input type="email" name="email" value="<%= settings.email %>" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                        <textarea name="address" rows="3" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"><%= settings.address %></textarea>
                    </div>
                </div>
            </div>

            <!-- Payment Methods Tab -->
            <div x-show="activeTab === 'payment'" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6" style="display: none;">
                <h3 class="text-lg font-bold text-gray-900 mb-6">Payment Methods</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">M-Pesa Paybill Number</label>
                        <input type="text" name="mpesaPaybill" value="<%= settings.mpesaPaybill %>" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="e.g. 247247">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">M-Pesa Till Number</label>
                        <input type="text" name="mpesaTill" value="<%= settings.mpesaTill %>" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="e.g. 123456">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">M-Pesa Account Number (Default)</label>
                        <input type="text" name="mpesaAccountNumber" value="<%= settings.mpesaAccountNumber %>" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="e.g. Business Name">
                    </div>
                </div>
            </div>

            <!-- Tax Settings Tab -->
            <div x-show="activeTab === 'tax'" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6" style="display: none;">
                <h3 class="text-lg font-bold text-gray-900 mb-6">Tax Settings</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tax Rate (%)</label>
                        <input type="number" step="0.01" name="taxRate" value="<%= settings.taxRate %>" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Currency Symbol</label>
                        <input type="text" name="currency" value="<%= settings.currency %>" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                    </div>
                </div>
            </div>

            <!-- Receipt Settings Tab -->
            <div x-show="activeTab === 'receipt'" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6" style="display: none;">
                <h3 class="text-lg font-bold text-gray-900 mb-6">Receipt Settings</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Receipt Header</label>
                        <input type="text" name="receiptHeader" value="<%= settings.receiptHeader %>" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="Welcome to WHIZ POS">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Receipt Footer</label>
                        <textarea name="receiptFooter" rows="3" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"><%= settings.receiptFooter %></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">'Served By' Label</label>
                        <input type="text" name="servedByLabel" value="<%= settings.servedByLabel %>" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="Cashier">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Printer Type</label>
                            <select name="printerType" class="w-full px-4 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none bg-white">
                                <option value="thermal" <%= settings.printerType === 'thermal' ? 'selected' : '' %>>Thermal Receipt (80mm)</option>
                                <option value="standard" <%= settings.printerType === 'standard' ? 'selected' : '' %>>Standard (A4/Letter)</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 pt-2">
                         <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="showPrintPreview" <%= settings.showPrintPreview ? 'checked' : '' %> class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm text-gray-700">Show Print Preview</span>
                        </label>
                         <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="onScreenKeyboard" <%= settings.onScreenKeyboard ? 'checked' : '' %> class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm text-gray-700">Enable On-Screen Keyboard</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Connected Devices Tab -->
            <div x-show="activeTab === 'devices'" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6" style="display: none;">
                <h3 class="text-lg font-bold text-gray-900 mb-6">Connected Devices</h3>
                <div class="space-y-6">
                    <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                        <h4 class="text-sm font-bold text-blue-900 mb-1">API Connection Details</h4>
                        <p class="text-xs text-blue-700 mb-4">Use these details to connect your Desktop POS or Mobile App to this Back Office.</p>

                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">API Key (Read-Only)</label>
                                <div class="flex items-center gap-2">
                                    <code class="flex-1 bg-white px-3 py-2 rounded border border-blue-200 text-xs font-mono text-gray-600 break-all">
                                        <!-- API Key from ENV or fallback -->
                                        <%= process.env.API_KEY || 'Please configure API_KEY in .env file' %>
                                    </code>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-sm font-bold text-gray-900 mb-3">Synchronization Status</h4>
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <div>
                                <p class="text-sm font-medium text-gray-900">Last Sync Activity</p>
                                <p class="text-xs text-gray-500">
                                    <%= settings.lastUpdated ? new Date(settings.lastUpdated).toLocaleString() : 'Never' %>
                                </p>
                            </div>
                            <span class="px-2.5 py-0.5 rounded-full text-xs font-medium <%= settings.lastUpdated ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800' %>">
                                <%= settings.lastUpdated ? 'Active' : 'Inactive' %>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Global Save Button -->
            <div class="mt-6 flex justify-end sticky bottom-6">
                 <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100">
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 shadow-sm shadow-blue-600/20 transition-colors flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Save Settings
                    </button>
                 </div>
            </div>
        </form>
    </div>
</div>

<!-- Alpine.js for Tabs (Ensure Alpine is loaded in layout) -->
<script src="//unpkg.com/alpinejs" defer></script>
